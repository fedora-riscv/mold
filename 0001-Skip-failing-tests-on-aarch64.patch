From 91c4af8e43ad2bf030d8f0d62594e7d2352a04c4 Mon Sep 17 00:00:00 2001
Message-Id: <91c4af8e43ad2bf030d8f0d62594e7d2352a04c4.1646773590.git.github@sicherha.de>
From: Christoph Erhardt <github@sicherha.de>
Date: Tue, 8 Mar 2022 19:05:50 +0100
Subject: [PATCH] Skip failing tests on aarch64

Upstream issues:
* https://github.com/rui314/mold/issues/382
* https://github.com/rui314/mold/issues/383
* https://github.com/rui314/mold/issues/384
---
 test/elf/hello-static-pie.sh     | 3 +++
 test/elf/ifunc-static-pie.sh     | 3 +++
 test/elf/noinhibit-exec.sh       | 3 +++
 test/elf/tls-gd-mcmodel-large.sh | 2 --
 test/elf/tls-ld-mcmodel-large.sh | 2 --
 5 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/test/elf/hello-static-pie.sh b/test/elf/hello-static-pie.sh
index 18700913..f0b7ae3d 100755
--- a/test/elf/hello-static-pie.sh
+++ b/test/elf/hello-static-pie.sh
@@ -10,6 +10,9 @@ mold="$(pwd)/mold"
 t=out/test/elf/$testname
 mkdir -p $t
 
+# Output binary segfaults on aarch64
+[ "$(uname -m)" = aarch64 ] && { echo skipped; exit; }
+
 # IFUNC is not supported on RISC-V yet
 [ "$(uname -m)" = riscv64 ] && { echo skipped; exit; }
 
diff --git a/test/elf/ifunc-static-pie.sh b/test/elf/ifunc-static-pie.sh
index 53a1c919..98cb3e6e 100755
--- a/test/elf/ifunc-static-pie.sh
+++ b/test/elf/ifunc-static-pie.sh
@@ -10,6 +10,9 @@ mold="$(pwd)/mold"
 t=out/test/elf/$testname
 mkdir -p $t
 
+# Output binary segfaults on aarch64
+[ "$(uname -m)" = aarch64 ] && { echo skipped; exit; }
+
 # IFUNC is not supported on RISC-V yet
 [ "$(uname -m)" = riscv64 ] && { echo skipped; exit; }
 
diff --git a/test/elf/noinhibit-exec.sh b/test/elf/noinhibit-exec.sh
index 44a26e54..6c90d82f 100755
--- a/test/elf/noinhibit-exec.sh
+++ b/test/elf/noinhibit-exec.sh
@@ -10,6 +10,9 @@ mold="$(pwd)/mold"
 t=out/test/elf/$testname
 mkdir -p $t
 
+# `mold -noinhibit-exec` segfaults on aarch64
+[ "$(uname -m)" = aarch64 ] && { echo skipped; exit; }
+
 cat <<EOF | $CC -o $t/a.o -c -xc -
 void foo();
 int main() { foo(); }
diff --git a/test/elf/tls-gd-mcmodel-large.sh b/test/elf/tls-gd-mcmodel-large.sh
index 9b518eea..09c591eb 100755
--- a/test/elf/tls-gd-mcmodel-large.sh
+++ b/test/elf/tls-gd-mcmodel-large.sh
@@ -12,8 +12,6 @@ mkdir -p $t
 
 if [ "$(uname -m)" = x86_64 ]; then
   dialect=gnu
-elif [ "$(uname -m)" = aarch64 ]; then
-  dialect=trad
 else
   echo skipped
   exit 0
diff --git a/test/elf/tls-ld-mcmodel-large.sh b/test/elf/tls-ld-mcmodel-large.sh
index ea5a5d41..79a72665 100755
--- a/test/elf/tls-ld-mcmodel-large.sh
+++ b/test/elf/tls-ld-mcmodel-large.sh
@@ -12,8 +12,6 @@ mkdir -p $t
 
 if [ "$(uname -m)" = x86_64 ]; then
   dialect=gnu
-elif [ "$(uname -m)" = aarch64 ]; then
-  dialect=trad
 else
   echo skipped
   exit 0
-- 
2.35.1

